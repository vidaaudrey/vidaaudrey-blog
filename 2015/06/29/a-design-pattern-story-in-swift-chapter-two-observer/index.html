<!DOCTYPE html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>A Design Pattern Story in Swift &#8211; Chapter 2: Observer</title><meta name=description content="In the deep forest, there is a beautiful witch who was born with the power to tell the past and future. In the beginning she was just a little girl in a near..."><link rel=canonical href=http://audreyli.me/2015/06/29/a-design-pattern-story-in-swift-chapter-two-observer/ ><link rel=stylesheet href=/assets/stylesheets/style-90cc5d106a.min.css><link rel="shortcut icon" href=/assets/favicon.ico><link rel=apple-touch-icon sizes=57x57 href=/assets/images/favicons/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/assets/images/favicons/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/assets/images/favicons/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/assets/images/favicons/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/assets/images/favicons/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/assets/images/favicons/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/assets/images/favicons/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/assets/images/favicons/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/assets/images/favicons/apple-touch-icon-180x180.png><link rel=icon type=image/png href=/assets/images/favicons/favicon-32x32.png sizes=32x32><link rel=stylesheet href=https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/css/bootstrap.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css><link type=application/atom+xml rel=alternate href=http://audreyli.me/feed.xml title=vidaaudrey-blog></head><body><header class=site-header><div class=wrapper><a class=site-title href=/ >vidaaudrey-blog</a><nav class=site-nav><a href=# class=menu-icon><svg viewBox="0 0 18 15"><path fill=#424242 d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/><path fill=#424242 d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/><path fill=#424242 d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/></svg></a><div class=trigger><a class=page-link href=/about/ >About</a> <a class=page-link href=/ >Home</a></div></nav></div></header><div class=page-content><div class=wrapper><article class=post itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">A Design Pattern Story in Swift &#8211; Chapter 2: Observer</h1><p class=post-meta><time datetime=2015-06-29T00:00:00-07:00 itemprop=datePublished>Jun 29, 2015</time> â€¢ <span itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>Audrey</span></span></p></header><div class=post-content itemprop=articleBody><p><span>In the deep forest, there is a beautiful witch who was born with the power to tell the past and future. In the beginning she was just a little girl in a nearby village. She knows everyone and whenever she sees danger in the future, she would warn the person. But soon she realized there are simply too many people to warn, and some of which don&#8217;t even want any help.</span></p><p><span>So she told the good people of the village that if they want to know her update, they can tune in to listen to her music station and they shall know the message from the music.</span></p><figure class=highlight><pre><code class=language-swift data-lang=swift>//: Define the message  for the all parties
enum WitchMessageType: String {
    case IsChrystalBadLuck = &quot;Bad_Luck&quot;
    case IsChrystalGoodLuck = &quot;Good_Luck&quot;
    case StationCreated = &quot;Station_Created&quot;
    case StationDestroyed = &quot;Station_Destroyed&quot;
}
class WitchMessage {
    let type: WitchMessageType
    let data: Any?
    init(type: WitchMessageType, data: Any?) {
        self.type = type
        self.data = data
    }
}


//: the Good Witch will tell everybody the name of the person she tells fortune for. Bad witch may not.
class GoodWitchMessage: WitchMessage {
    var name: String
    var isBadLuck: Bool { return self.type == WitchMessageType.IsChrystalBadLuck }
    
    init(name: String, type: WitchMessageType, data: Any?){
        self.name = name
        super.init(type: type, data: data)
    }
}

// People who listen to her music station are observers
protocol Observer {
    var name:String { get }
    func notify(witchMessage: WitchMessage)
}


extension CustomStringConvertible where Self: Observer {
    var description: String { return self.name }
}


protocol Station {
    func addObserver(observers: Observer...)
    func removerObserver(observer: Observer)
}


class BaseStation: Station, CustomStringConvertible {
    private var observers: [Observer] = []
    var description: String { return &quot;I am a Station and my observers are: \(observers)&quot; }
    private var orderedQueue = dispatch_queue_create(&quot;orQ&quot;, DISPATCH_QUEUE_CONCURRENT)
    
    //: She can only add or remove one person at a time
    func addObserver(observers: Observer...) {
        dispatch_barrier_sync(orderedQueue) {
            observers.map { self.observers.append($0) }
        }
    }
    
    
    func removerObserver(observer: Observer) {
        dispatch_barrier_sync(orderedQueue) { () -&gt; Void in
            self.observers.filter{ $0.name == observer.name}
            print(&quot;removed observer \(observer.name)&quot;)
        }
    }
    func sendNotificationToAll(witchMessage: WitchMessage) {
        dispatch_sync(orderedQueue) { () -&gt; Void in
            self.observers.map{ $0.notify(witchMessage) }
        }
    }
}

class WitchStation: BaseStation {
    
    func checkCrystalBall(name: String) -&gt; Bool {
        var messageType = WitchMessageType.IsChrystalGoodLuck
        
        if RandomYesOrNoGeneratorByInt.random() {
            print(&quot;Witch Tell: Good luck ahead&quot;)
        } else {
            messageType = WitchMessageType.IsChrystalBadLuck
            print(&quot;Witch Tell: Bad luck ahead&quot;)
        }
        
        sendNotificationToAll(GoodWitchMessage(name: name, type: messageType, data: nil))
        return messageType == WitchMessageType.IsChrystalGoodLuck
    }
}

//: all that listen to her messages
class Villager: Observer {
    var name: String
    init(name: String){
        self.name = name
    }
    func notify(witchMessage: WitchMessage) {
        print(&quot;Villager \(name) got notified&quot;)
        guard let message = witchMessage as? GoodWitchMessage else {
            print(&quot;This message might come from the Bad Witch&quot;)
            return
        }
        print(&quot;Message for \(message.name). Is Bad Luck? \(witchMessage.type)&quot;)
    }
    
    func logMyFortune(fortune: String) {
        print(&quot;Log: \(fortune)&quot;)
    }
}

class AlarmSystem: Observer {
    var name: String
    init(name: String){
        self.name = name
    }
    func notify(witchMessage: WitchMessage) {
        print(&quot;\(name) got notified&quot;)
        guard let message = witchMessage as? GoodWitchMessage else {
            print(&quot;This message might come from the Bad Witch&quot;)
            return
        }
        if witchMessage.type == WitchMessageType.IsChrystalBadLuck  {
            print(&quot;Something unfortunate will happen to \(message.name). An alarm is being sent out&quot;)
        }
    }
}

class Hero: Observer {
    var name: String
    init(name: String){
        self.name = name
    }
    func notify(witchMessage: WitchMessage) {
        print(&quot;Hero got notified&quot;)
        if witchMessage.type == WitchMessageType.IsChrystalBadLuck {
            saveTheUnfortunate()
        }
    }
    func saveTheUnfortunate() {
        print(&quot;A hero will come to save you&quot;)
    }
}

//: Test the system
let jane = Villager(name: &quot;Jane&quot;)
let alarm = AlarmSystem(name: &quot;Alarm System&quot;)
let jack = Hero(name: &quot;Hero Jack&quot;)

let witchStation = WitchStation()
witchStation.addObserver(jane, alarm, jack)
print(witchStation.description)
print(&quot;--check luck for Nicole ---&quot;)
witchStation.checkCrystalBall(&quot;Nicole&quot;)

print(&quot;---check luck for Mia --&quot;)
witchStation.checkCrystalBall(&quot;Mia&quot;)</code></pre></figure><p>&nbsp;</p><p><a href=/assets/images/wp-content/uploads/2015/06/Observer-Pattern.png><img class="aligncenter size-full wp-image-962" src=/assets/images/wp-content/uploads/2015/06/Observer-Pattern.png alt="Observer Pattern" width=489 height=227></a></p><p>&nbsp;</p><p><a href=https://hdwallpapers.cat/do_not_listen_to_him_forest_girl_fruit_hd-wallpaper-1852331/ >Image</a></p></div></article></div></div><footer class=site-footer><div class=wrapper><h2 class=footer-heading></h2><div class=footer-col-wrapper><div class="footer-col footer-col-1"><ul class=contact-list><li></li><li><a href=mailto:me@audreyli.me>me@audreyli.me</a></li></ul></div><div class="footer-col footer-col-2"><ul class=social-media-list><li><a href=https://twitter.com/vidaaudrey><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill=#828282 d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                  c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                  c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                  C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                  c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                  c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg> </span><span class=username>vidaaudrey</span></a></li></ul></div><div class="footer-col footer-col-3"><p class=text>Audrey Li's personal blog</p></div></div></div></footer><script src=https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js></script><script src=https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/js/bootstrap.js></script><script src=/assets/javascript/index-f8fab38504.min.js></script></body></html>